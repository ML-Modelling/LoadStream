<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoadStream Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f9f9f9;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .chart-container {
      position: relative;
      height: 200px;
    }
    .log-box {
      background: #fff3cd;
      border-left: 5px solid #ffecb5;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <header class="header fixed-top bg-white shadow-sm">
    <nav class="navbar navbar-expand-lg navbar-light container-fluid px-4">
      <a class="navbar-brand" href="/">LoadStream</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav gap-3">
          <li class="nav-item"><a class="nav-link" href="/simulation.html">Simulation</a></li>
          <li class="nav-item"><a class="nav-link active" href="/chart.html">Chart</a></li>
          <li class="nav-item"><a class="nav-link" href="/report.html">Reports</a></li>
          <li class="nav-item"><a class="nav-link" href="/analysis.html">Analysis</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <div class="container py-5 mt-5">
    <div class="text-center mb-4">
      <h2 class="fw-bold"><i class="bi bi-bar-chart-line"></i> Simulation Analysis Dashboard</h2>
      <p class="text-muted">Visualize and analyze server load balancing performance</p>
      <button id="runBtn" class="btn btn-success mt-3"><i class="bi bi-play-circle"></i> Run Simulation</button>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="fw-bold">Latency Over Time</h5>
          <div class="chart-container"><canvas id="latencyChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="fw-bold">Throughput Over Time</h5>
          <div class="chart-container"><canvas id="throughputChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="fw-bold">Efficiency Over Time</h5>
          <div class="chart-container"><canvas id="efficiencyChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="fw-bold">Completion Rate Over Time</h5>
          <div class="chart-container"><canvas id="completionRateChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="fw-bold">Simulation Logs</h5>
      <div class="log-box" id="logBox">Loading logs...</div>
    </div>

    <div class="text-center">
      <a href="/download/json" class="btn btn-primary me-3"><i class="bi bi-download"></i> Download JSON</a>
      <a href="/download/csv" class="btn btn-secondary"><i class="bi bi-file-earmark-spreadsheet"></i> Download CSV</a>
    </div>
  </div>

  <script>
    async function fetchChartData() {
      const res = await fetch('/get_charts');
      return await res.json();
    }

    async function loadLogs() {
      const res = await fetch('/get_logs');
      const logs = await res.json();
      const logBox = document.getElementById('logBox');
      logBox.innerHTML = logs.map(log => `
        <div><strong>Step ${log.step}</strong> - Action: ${log.action.join(", ")} | Reward: ${log.reward.toFixed(2)}</div>
      `).join('');
    }

    async function renderCharts() {
      const data = await fetchChartData();

      new Chart(document.getElementById('latencyChart'), {
        type: 'line',
        data: {
          labels: data.time_steps,
          datasets: [{
            label: 'Latency (ms)',
            data: data.latency,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13,110,253,0.2)',
            fill: true
          }]
        }
      });

      new Chart(document.getElementById('throughputChart'), {
        type: 'line',
        data: {
          labels: data.time_steps,
          datasets: [{
            label: 'Throughput (req/s)',
            data: data.throughput,
            borderColor: '#20c997',
            backgroundColor: 'rgba(32,201,151,0.2)',
            fill: true
          }]
        }
      });

      new Chart(document.getElementById('efficiencyChart'), {
        type: 'line',
        data: {
          labels: data.time_steps,
          datasets: [{
            label: 'Efficiency (%)',
            data: data.efficiency,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255,193,7,0.2)',
            fill: true
          }]
        }
      });

      new Chart(document.getElementById('completionRateChart'), {
        type: 'bar',
        data: {
          labels: data.time_steps,
          datasets: [{
            label: 'Completion Rate',
            data: data.completion_rate,
            backgroundColor: '#6610f2'
          }]
        }
      });
    }

    document.getElementById('runBtn').addEventListener('click', async () => {
      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
      try {
        const response = await fetch('/run_simulation');
        if (response.ok) {
          await renderCharts();
          await loadLogs();
        } else {
          alert('Simulation failed to run.');
        }
      } catch (err) {
        alert('Error running simulation.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Simulation';
      }
    });

    window.onload = async () => {
      await renderCharts();
      await loadLogs();
    };
  </script>
</body>
</html>
